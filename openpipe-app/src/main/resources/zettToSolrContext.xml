<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:util="http://www.springframework.org/schema/util"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
       http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-2.0.xsd
       http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.0.xsd">

   <bean id="zettDataSource" class="org.apache.commons.dbcp.BasicDataSource">
      <property name="url" value="jdbc:postgresql://frode:5432/zett"/>
      <property name="driverClassName" value="org.postgresql.Driver"/>
      <property name="username" value="postgres"/>
      <property name="password" value=""/>
      <property name="maxActive" value="2"/>
      <property name="initialSize" value="1"/>
      <property name="defaultAutoCommit" value="true"/>
      <property name="poolPreparedStatements" value="true"/>
      <property name="accessToUnderlyingConnectionAllowed" value="true"/>
   </bean>

   <bean id="jdbcTemplate" class="org.springframework.jdbc.core.JdbcTemplate">
      <property name="dataSource" ref="zettDataSource"/>
      <property name="fetchSize" value="50"/>
   </bean>

   <bean id="jdbcZettDocumentProducer" class="no.trank.openpipe.jdbc.SimpleJdbcDocumentProducer">
      <property name="jdbcTemplate" ref="jdbcTemplate"/>
      <property name="jdbcStats" ref="jdbcStats"/>
      <property name="addPreSql" value="
           update
              ad_objects
           set
              in_progress=1
           where
              object_id in (select object_id from ad_objects where publishing_status=1 and is_modified=1 limit 2500)"/>
      <property name="addSql" value="
           select
              ad.object_id as id,
              o.short_description as short_description,
              c.title as company,
              o.created_time as date,
              o.category as topcategory,
              cat.fullname as category,
              atr_due.value as applicationdue,
              atr_pos.value as positiontitle,
              atr_eng.value as engagementtype,
              addr.geography as full_area
           from 
              ad_objects ad
              left join objects c on ad.company_id=c.object_id
              left join objects o on ad.object_id=o.object_id
              left join ad_object_categories cat on ad.category_id=cat.category_id
              left join object_attributes_part atr_due on ad.object_id=atr_due.object_id and atr_due.name='applicationdue'
              left join object_attributes_part atr_pos on ad.object_id=atr_pos.object_id and atr_pos.name='positiontitle'
              left join object_attributes_part atr_eng on ad.object_id=atr_eng.object_id and atr_eng.name='engagementtype'
              left join addresses addr on ad.address_id=addr.address_id
           where
              ad.in_progress=1"/>
      <property name="addPostSql" value="update ad_objects set in_progress=0,is_modified=0 where in_progress=1"/>
   </bean>

   <bean id="solrDocumentProcessor" class="no.trank.openpipe.solr.step.SolrDocumentProcessor">
      <property name="documentPoster">
         <bean class="no.trank.openpipe.solr.SolrHttpDocumentPoster">
            <property name="postUrl" value="http://eak:8983/solr/update"/>
            <property name="docsPerPost" value="500"/>
         </bean>
      </property>
      <property name="solrSchemaUrl" value="http://eak:8983/solr/admin/get-file.jsp?file=schema.xml"/>
   </bean>

   <bean id="pipeline" class="no.trank.openpipe.api.Pipeline">
      <property name="pipelineSteps">
         <list>
            <bean class="no.trank.openpipe.step.RegexField">
               <property name="copyOnMiss" value="true"/>
               <property name="fieldNameMap">
                  <map>
                     <entry key="full_area" value="area"/>
                  </map>
               </property>
               <property name="fromPattern" value="^Norge\/([^\/]+)\/.+$"/>
               <property name="toPattern" value="$1"/>
            </bean>
            <bean class="no.trank.openpipe.step.RegexField">
               <property name="copyOnMiss" value="true"/>
               <property name="fieldNameMap">
                  <map>
                     <entry key="topcategory" value="topcategory"/>
                  </map>
               </property>
               <property name="fromPattern" value="^Stilling\/(.+)$"/>
               <property name="toPattern" value="$1"/>
            </bean>
            <bean class="no.trank.openpipe.step.HierarchicalSplitter">
               <property name="name" value="category verbose facet splitter"/>
               <property name="fromFieldName" value="category"/>
               <property name="toFieldName" value="categoryVerboseFacet"/>
               <property name="levelSplit" value="/"/>
               <property name="alternativeSplit" value="¦"/>
            </bean>
            <bean class="no.trank.openpipe.step.HierarchicalSplitter">
               <property name="name" value="category facet splitter"/>
               <property name="fromFieldName" value="category"/>
               <property name="toFieldName" value="categoryFacet"/>
               <property name="levelSplit" value="/"/>
               <property name="alternativeSplit" value="¦"/>
               <property name="numLevels" value="1"/>
            </bean>
            <bean class="no.trank.openpipe.step.ConvertDate">
               <property name="fieldNameMap">
                  <map>
                     <entry key="date" value="date"/>
                  </map>
               </property>
               <property name="patternMap">
                  <map>
                     <entry key="yyyy-MM-dd HH:mm:ss" value="yyyy-MM-dd'T'HH:mm:ss'Z'"/>
                     <entry key="yyyy-MM-dd HH:mm:ss.SSS" value="yyyy-MM-dd'T'HH:mm:ss'Z'"/>
                  </map>
               </property>
            </bean>
            <bean class="no.trank.openpipe.step.StripHtml">
               <property name="fieldNameMap">
                  <map>
                     <entry key="short_description" value="short_description_indexed"/>
                  </map>
               </property>
            </bean>
            <bean class="no.trank.openpipe.step.RemoveFields">
               <property name="fieldNames">
                  <list>
                     <value>full_area</value>
                  </list>
               </property>
            </bean>
            <!-- <bean class="no.trank.openpipe.step.Debug"/> -->
            <ref local="solrDocumentProcessor"/>
         </list>
      </property>
   </bean>

   <bean id="pipelineApplicationBean" class="no.trank.openpipe.PipelineRunner">
      <property name="documentReader">
         <ref local="jdbcZettDocumentProducer"/>
      </property>
      <property name="pipeline">
         <ref local="pipeline"/>
      </property>
   </bean>
   
   <bean id="jdbcPoller" class="no.trank.openpipe.jdbc.JdbcPoller">
      <property name="pipelineRunner" ref="pipelineApplicationBean"/>
   </bean>
   
   <bean id="jdbcStats" class="no.trank.openpipe.jdbc.HtmlJdbcStats"/>
   
   <bean id="jdbcAdmin" class="no.trank.openpipe.jdbc.JdbcAdmin" init-method="start">
      <property name="server" ref="jettyServer"/>
      <property name="jdbcPoller" ref="jdbcPoller"/>
      <property name="jdbcStats" ref="jdbcStats"/>
      <property name="jettyEnabled" value="true"/>
      <property name="pollingEnabled" value="false"/>
      <property name="intervalMillis" value="1000"/>
   </bean>
   
   <bean id="jettyServer" class="org.mortbay.jetty.Server">
      <property name="connectors">
         <bean class="org.mortbay.jetty.nio.BlockingChannelConnector">
            <property name="host" value="127.0.0.1"/>
            <property name="port" value="4444"/>
         </bean>
      </property>
      <property name="handlers">
         <bean class="org.mortbay.jetty.servlet.ServletHandler">
            <property name="servlets">
               <bean class="org.mortbay.jetty.servlet.ServletHolder">
                  <property name="servlet" ref="jdbcAdmin"/>
                  <property name="name" value="root"/>
               </bean>
            </property>
            <property name="servletMappings">
               <bean class="org.mortbay.jetty.servlet.ServletMapping">
                  <property name="pathSpec" value="/"/>
                  <property name="servletName" value="root"/>
               </bean>
            </property>
         </bean>
      </property>
      <property name="threadPool">
         <bean class="org.mortbay.thread.BoundedThreadPool">
            <property name="lowThreads" value="1"/>
            <property name="minThreads" value="2"/>
         </bean>
      </property>
   </bean>
</beans>
